<!--DOCTYPE html tells the browser that the document is an html page-->
<!DOCTYPE html>
<!--Begining of html code-->
<html xmlns:th="http://www.thymeleaf.org">
<!--Begining of head section--> 
<head>
	 <title>Music Player</title>
	 <!--Linking the CSS stylesheet using extrenal CSS-->
	 <link rel="stylesheet" type="text/css" href="MusicPlayerStyle.css">
	 <!--Font Awesome script for using icons from font awesome-->
	 <script src="https://kit.fontawesome.com/6f0f83005a.js" crossorigin="anonymous"></script>
	 <!--Adds responsiveness to the website-->
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/>
</head>
<!--End of head section-->

<!--Begining of the body section-->
<body>
	<!--Begining of navigation bar section-->
	<nav>
		<!--Music Player Logo div-->
		<div id="music-player-tag">
		 <div id="music-player-logo">
			 <img src="Images/music-player-logo.png">
		 </div>
		 <!--Music Player Logo div end-->

		 <!--Music Player Title-->
		 <div id="music-player-name">
             Music<br/><b>Player</b>
		 </div>
		</div>
		 <!--Music Player Title div end-->

         <!--Search Bar div-->
         <div id="search-bar-utility">
		 <div id="search-bar">
			 <form>
				 <input type="text" placeholder="Search...">
				 <!--Search Icon-->
				 <i class="fas fa-search"></i>
			 </form>
		 </div>
		 <!--Search Bar div end-->

         <!--Notification Bell div-->
		 <div id="notifications">
			 <i class="fas fa-bell"></i>
		 </div>
		 <!--Notification Bell div end-->

         <!--User Image div-->
		 <div id="user">
			 <img src="Images/user-image.jpg">
		 </div>
		</div>
		 <!--User Image div end-->
	</nav>
    <!--End of navigation bar section-->

    <!--Main body of the Music Player Home Page-->
	<main>
		<!--Home Screen Carousel which is slideshown with class slideshow-->

		<div id="new-releases">
			<!-- Dùng th:each để lặp qua danh sách Album -->
			<th:block th:each="Album : ${ListAlbum}">
				<a th:href="@{'/albums/' + ${Album.id}}">
					<img
						 th:if="${Album != null and Album.getBackgroundUrl() != null}"
						 th:src="@{${Album.getBackgroundUrl()}}"
					/>
				</a>
			</th:block>

		</div>


		<div id="latest-release">
			<!--Heading-->
			<h1>Latest Release</h1>
            <!--Latest Release Item div which contains the latest songs displayed-->
			<div  id="latest-release-items">
				<!--Item 1-->
                <div th:each="Song : ${ListNewSong}" id="latest-release-item">
                	<!--Song Image-->
					<div style="width: 100px;height: 100px" th:if="${Song != null and Song.getArtist() != null}"
						 th:style="'background-image: url(' + ${Song.getArtist().getAvatarUrl()} + ')'"
						 id="latest-release-img">
                		<!--Play Button div which is hidden and appears on hover-->
						<div id="latest-release-img-button" class="hide">
							<a class="font-color play-song" th:data-song-id="${Song.getId()}" href="javascript:void(0);">
								<i class="fas fa-play"></i>
							</a>
						</div>

						<!--End of Play Button Div-->
                	 </div>
                	 <!--End of Song Image-->
                     <!--Div containing song details-->
                	 <div id="latest-item-title" class="hide">
                	     <b th:text="${Song.getTitle()}"></b>
                	     <p th:text="${Song.getArtist().getArtistName()}"></p>
                     </div>
                     <!--End of div containing song details-->
                     <!--Dropdown menu icon-->
                     <div id="dropdown">
                        <i class="fas fa-chevron-circle-down">
                     	<div id="dropdown-menu" class="hide">
                     		<div id="dropdown-list">
                     			<i class="fas fa-play"></i>
                     			&nbsp;
                     		    <a class="font-color play-song" th:data-song-id="${Song.getId()}" href="javascript:void(0);">Play Now</a>
                     	    </div>
                     		<hr/>
							<div id="dropdown-list">
								<i class="fas fa-plus"></i>
								<a class="font-color add-to-queue" href="javascript:void(0);" th:data-song-id="${Song.getId()}">Add to Queue</a>
							</div>
                     		<hr/>
                     		<div id="dropdown-list">
                     			<i class="fas fa-exclamation-circle"></i>
                     			&nbsp;
                     		    <a href="#latest-release">Get Info</a>
                     	    </div>
                     	</div>
                        </i>
                     </div>
                     <!--End of dropdown menu-->
                </div>
                <!--End of Item 1-->
			</div>
			<!--End of latest release item div-->
		</div>
		<!--End of latest release section-->

		<!--Begining of Popular Artists section-->
		<div id="popular-artists">
			 <!--Popular Artist Section Title-->
			 <h1>Popular Artists</h1>
			 <!--Begining of the popular artist list section-->
			 <div  id="popular-artist-list">
			 	 <!--Artist 1-->
			     <div th:each="Artist :${ListArtist}"  th:style="'background-image: url(' + ${Artist.getAvatarUrl()} + ')'" id="popular-artists-image">
				     <div id="popular-artists-text" class="hide">
				     	<a th:text="${Artist.getArtistName()}" >

			            </a>
			         </div>
			     </div>

		    </div>
		    <!--End of popular artists list div-->
	    </div>
        <!--End of popluar artist section-->

       <!--Begining of playlist section-->

        <!--End of playlist section-->

        <!--Begining of genre section-->
	    <div id="genre">
	    	<div th:each="Genre : ${ListGenre}"id="genre-item">
	    		 <div  th:text="${Genre.getName()}" id="genre-item-background-1"></div>
	    	</div>
	    </div>
	    <!--End of genre section-->

	    <!--Begining of latest english songs section-->
	    <div id="latest-songs">
	    	<!--Latest English Songs title-->
	    	<h1>Hot Song</h1>
	    	<!--Songs List Div-->
	    	<div id="latest-songs-list">
	    		<!--Song 1-->
	    		<div th:each="Song : ${ListHotSong}" id="latest-songs-item">
	    			<!--Song Image-->


					<div  th:style="'background-image: url(' + ${Song.getArtist().getAvatarUrl()} + ')'" id="latest-songs-item-img-1">
                     <!--Play button which is hidden and appears on hover-->
	    			 <div id="latest-songs-item-button" class="hide">
                		 <i class="fas fa-play play-song" th:data-song-id="${Song.getId()}" href="javascript:void(0);"></i>
                	 </div>
                	 <!--End of play button-->
	    			</div>
	    			<!--End of song image-->
	    			<!--Song title-->
	    			<div id="latest-songs-item-title">
						<div style="display: flex">
							<b th:text="${#strings.length(Song.getTitle()) &gt; 10 ? Song.getTitle().substring(0, 10) + '...' : Song.getTitle()}"></b>
							<div style="	margin-left: 110px;" id="dropdown">
								<i class="fas fa-chevron-circle-down">
									<div id="dropdown-menu" class="hide">
										<div id="dropdown-list">
											<i class="fas fa-play"></i>
											&nbsp;
											<a class="font-color play-song" th:data-song-id="${Song.getId()}" href="javascript:void(0);">Play Now</a>
										</div>
										<hr/>
										<div id="dropdown-list">
											<i class="fas fa-plus"></i>
											<a class="font-color add-to-queue" href="javascript:void(0);" th:data-song-id="${Song.getId()}">Add to Queue</a>
										</div>

										<hr/>
										<div id="dropdown-list">
											<i class="fas fa-exclamation-circle"></i>
											&nbsp;
											<a href="#latest-release">Get Info</a>
										</div>
									</div>
								</i>
							</div>
						</div>


						<br/>
						<p th:text="${Song.getArtist().getArtistName()}" style="color:lightgrey"></p>
	    			</div>

	    			<!--End of song title-->
	    		</div>
	    		<!--End of song 1-->


	       </div>
	       <!--End of songs list div-->
	    </div>
	    <!--End of latest english songs section-->

	    <!--Begining of latest hindi songs section-->
	    <div id="latest-songs" style="margin-top: 20px">
	    	<!--Latest Hindi Songs title-->
	    	<h1>Hot Album</h1>
	    	<!--Latest songs list div-->
	    	<div id="latest-songs-list">

				<div th:each="Album : ${ListHotAlbum}" id="latest-songs-item">
					<!--Song Image-->
					<a th:href="@{'/albums/' + ${Album.id}}">
						<div  th:style="'background-image: url(' + ${Album.getBackgroundUrl()} + ')'" id="latest-songs-item-img-1">
							<!--Play button which is hidden and appears on hover-->
							<div id="latest-songs-item-button" class="hide">
								<i class="fas fa-play"></i>
							</div>
							<!--End of play button-->
						</div>
					</a>
					<!--End of song image-->
					<!--Song title-->
					<div id="latest-songs-item-title">
						<div style="display: flex">
							<b th:text="${#strings.length(Album.getName()) &gt; 10 ? Album.getName().substring(0, 10) + '...' : Album.getName()}"></b>
							<div style="	margin-left: 110px;" id="dropdown">
								<i class="fas fa-chevron-circle-down">
									<div id="dropdown-menu" class="hide">

										<div id="dropdown-list">
											<i class="fas fa-plus"></i>
											&nbsp;
											<a href="#latest-release">Add to Queue</a>
										</div>
										<hr/>
										<div id="dropdown-list">
											<i class="fas fa-exclamation-circle"></i>
											&nbsp;
											<a href="#latest-release">Get Info</a>
										</div>
									</div>
								</i>
							</div>
						</div>
						<p th:text="${Album.getArtist().getArtistName()}" style="color:lightgrey"></p>
					</div>
					<!--End of song title-->
				</div>
	    	</div>
	    	<!--End of latest songs list div-->
	    </div>
	    <!--End of latest hindi song section-->
	</main>
	<!--End of main section-->

	<!--Begining of aside section-->
    <aside id="QueueList">
        <!--Aside section header-->
   	    <div id="aside-header">
   	     <!--Aside section title-->
   	      <div id="aside-title">
   		     Queue
   	      </div>
          <!--End of aside section title-->
          <!--Dropdown menu-->
       	 <div id="aside-dropdown">
   		     <form>
   			     <select>
   			         <option id="Queue" label="Queue">Queue</option>
   			         <option id="Playlist" lable="Playlist"><a href="MusicPlayerHomePage2.html">Playlist</a></option>
   		         </select>
   	         </form>
   	     </div>
         <!--End of dropdown menu-->
        </div>
        <!--End of aside section header-->
        <!--List of Songs-->
        <!--Song 1-->



       	 <!--End of song 7-->
   </aside>
   <!--End of aside section-->

   <footer>
   <!--The bottom music bar which pops up when we play a music-->
	   <div id="music-bar" class="hide">
		   <!-- Music Icon -->
		   <div id="music-icon">
			   <img id="music-icon-img" src="default-avatar.png" alt="music-icon"> <!-- Hình ảnh mặc định -->
		   </div>
		   <!-- End of music icon -->
		   <!-- Music title -->
		   <div id="music-title">
			   <b></b>
			   <div id="favourite">
				   <i class="far fa-heart"></i>
			   </div>
			   <div id="remove">
				   <i class="fas fa-ban"></i>
			   </div>
			   <br>
			   <artist id="music-player-title-artist"></artist>
		   </div>
		   <!-- End of music title -->
		   <!-- Play buttons -->
		   <div id="play-buttons">
			   <i class="fas fa-random"></i>
			   <i class="fas fa-backward"></i>
			   <i id="play-pause-button" class="fas fa-pause-circle"></i> <!-- Thêm id cho nút phát/dừng -->
			   <i class="fas fa-forward"></i>
			   <i class="fas fa-undo-alt"></i>
		   </div>
		   <!-- End of play buttons -->
		   <!-- Music start time -->
		   <div id="start-time">
			   0:00
		   </div>
		   <!-- End of music start time -->
		   <!-- Music end time -->
		   <div id="end-time">
			   5:04
		   </div>
		   <!-- End of music end time -->
		   <!-- Beginning of the progress bar -->
		   <!-- Thanh tiến trình -->

		   <progress id="progress-bar" class="progress_controls" max="100" value="0"></progress>

		   <!-- End of progress bar -->
		   <!-- Miscellaneous icons -->
		   <div id="queue">
			   <i class="fas fa-bars"></i>
		   </div>
		   <div id="volume">
			   <i class="fas fa-volume-up"></i>
		   </div>

		   <!-- End of miscellaneous icons -->
	   </div>


	   <!--End of music bar-->
   </footer>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		var songPlay = /*[[${SongPlay}]]*/ null;
		if (songPlay !== null) {
			document.addEventListener('DOMContentLoaded', function() {
				var musicBar = document.getElementById('music-bar');
				if (musicBar.classList.contains('hide')) {
					musicBar.classList.remove('hide');
				}
			});
		}
		/*]]>*/
	</script>
	<script th:inline="javascript">
		$(document).ready(function() {
			var currentSong = new Audio(); // Đối tượng Audio để phát nhạc
			var isPlaying = false; // Biến flag để theo dõi trạng thái phát của nhạc
			var undoClickCount = 0; // Số lần click undo
			var isLooping = false; // Biến để kiểm tra xem có đang lặp lại bài hát không
			var isRandoming=false;
			var listqueueitem=getAllQueueItems();
			var currentPostition=0;
			// Bắt sự kiện click vào thẻ <a>
			$(document).on('click', '.play-song', function(event) {
				event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ <a>
				var songId = $(this).data("song-id"); // Lấy ID của bài hát
				// Gửi yêu cầu Ajax đến controller
				$.ajax({
					type: "GET",
					url: "/playSong/" + songId,
					success: function(response) {
						$("#music-bar").removeClass("hide"); // Hiển thị thanh phát nhạc
						$("#music-title b").text(response.title); // Cập nhật tiêu đề bài hát
						if (response.artistName) {
							$("#music-title artist").text(response.artistName); // Cập nhật tên nghệ sĩ
						} else {
							$("#music-title artist").text("Unknown Artist");
						}
						if (response.avtUrl) {
							$("#music-icon img").attr("src", response.avtUrl); // Cập nhật hình ảnh nghệ sĩ
						} else {
							$("#music-icon img").attr("src", "default-avatar.png"); // Sử dụng hình ảnh mặc định
						}
						// Dừng bài hát hiện tại nếu có và phát bài hát mới
						currentSong.src = response.songUrl; // Gán URL mới cho đối tượng Audio
						togglePlayPause(); // Phát hoặc dừng nhạc tùy thuộc vào trạng thái isPlaying
					},
					error: function(xhr, status, error) {
						console.error(error);
					}
				});
			});

			// Bắt sự kiện click vào thẻ <a> có class .add-to-queue
			$(document).on('click', '.add-to-queue', function(event) {
				event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ <a>
				var songId = $(this).data("song-id"); // Lấy ID của bài hát
				// Gửi yêu cầu Ajax đến controller
				$.ajax({
					type: "GET",
					url: "/playSong/" + songId,
					success: function(response) {
						var title = response.title;  // Extracting title from response
						var artist = response.artistName;  // Extracting artist from response
						var avtUrl = response.avtUrl;  // Extracting avatar URL from response

						var queueitem1 = '<div class="queue-item">' +
								'<div class="queue-item-img" style="background-image: url(\'' + avtUrl + '\');">' +
								'<div  id="latest-release-img-button" class="">' +
								'<a class="font-color play-song" data-song-id="' + songId + '" href="javascript:void(0);">' +
								'<i style="color: transparent" class="fas fa-play"></i>' +
								'</a>' +
								'</div>' +
								'</div>' +
								'<div class="queue-item-title">' +
								'<b>' + title + '</b>' +
								'<p style="color:lightgrey;">' + artist + '</p>' +
								'</div>' +
								'<div class="queue-favourite">' +
								'<i class="fas fa-trash-alt"></i>' +
								'</div>' +
								'</div>';

						$("#QueueList").append(queueitem1);
					},
					error: function(xhr, status, error) {
						console.error(error);
					}
				});
			});
			$('.fa-forward').click(function(event) {
				event.preventDefault();

				// Get all queue items
				var nextQueueItem;
				var queueItems = getAllQueueItems();
				if (isRandoming){

					var randomIndex = Math.floor(Math.random() * queueItems.length);
					console.log(randomIndex)
					nextQueueItem = queueItems.eq(randomIndex);
				}else {
					currentPostition++;
					console.log(currentPostition)

					if (currentPostition === queueItems.length ) {
						currentPostition = 0; // Reset to the first item if it's the last item
						nextQueueItem = queueItems.eq(0);
					}else
					{
						nextQueueItem = queueItems.eq(currentPostition);
					}
				}
				nextQueueItem.find('.play-song').click();



			});
			$('.fa-backward').click(function(event) {
				event.preventDefault();

				// Get all queue items
				var queueItems = getAllQueueItems();
				currentPostition--;
				console.log(currentPostition)
				var nextQueueItem;
				// If no item is currently playing or if it's the last item, do nothing
				if (currentPostition == -1 ) {
					currentPostition =  queueItems.length-1; // Reset to the first item if it's the last item
					nextQueueItem = queueItems.eq(currentPostition);
				}else
				{
					nextQueueItem = queueItems.eq(currentPostition);
				}
				nextQueueItem.find('.play-song').click();


			});
			$(document).on('click', '.queue-favourite', function(event) {
				event.preventDefault();

				// Tìm phần tử cha của biểu tượng xóa
				var queueItem = $(this).closest('.queue-item');

				// Xoá phần tử cha ra khỏi DOM
				queueItem.remove();

				// Cập nhật danh sách phần tử trong queue
				listqueueitem = getAllQueueItems();
			});
			function getAllQueueItems() {
				return $('#QueueList').find('.queue-item');
			}
			$(".fa-undo-alt").click(function() {
				if (isLooping ==false) {
					// Nếu lần nhấn là lẻ
					isLooping = true; // Bật chế độ lặp lại bài hát
					$(this).addClass("undo-clicked"); // Thêm class để thay đổi màu của biểu tượng
				} else {
					// Nếu lần nhấn là chẵn
					isLooping = false; // Tắt chế độ lặp lại bài hát
					$(this).removeClass("undo-clicked"); // Loại bỏ class để trở về màu mặc định
				}
			});
			$(".fa-random").click(function() {
				if (isRandoming ==false) {
					// Nếu lần nhấn là lẻ
					isRandoming = true; // Bật chế độ lặp lại bài hát
					$(this).addClass("undo-clicked"); // Thêm class để thay đổi màu của biểu tượng
				} else {
					// Nếu lần nhấn là chẵn
					isRandoming = false; // Tắt chế độ lặp lại bài hát
					$(this).removeClass("undo-clicked"); // Loại bỏ class để trở về màu mặc định
				}
			});
			// Bắt sự kiện click vào nút phát/dừng
			$("#play-pause-button").click(function() {
				togglePlayPause();
			});

			// Bắt sự kiện thay đổi giá trị thanh tiến trình
			$("#progress-bar").on("input", function() {
				var progress = $(this).val();
				var currentTime = (currentSong.duration * progress) / 100;
				currentSong.currentTime = currentTime;
			});
			// Bắt sự kiện mouse down để tua
			$("#progress-bar").on("click", function(e) {
				var max = $(this).width(); // Lấy chiều rộng của progress bar
				var pos = e.pageX - $(this).offset().left; // Vị trí của con trỏ chuột tính từ đầu của progress bar
				var percentage = (pos / max) * 100; // Tính phần trăm dựa trên vị trí của con trỏ
				var duration = currentSong.duration; // Lấy thời lượng của bài hát

				var currentTime = (duration * percentage) / 100; // Tính thời gian hiện tại dựa trên phần trăm

				currentSong.currentTime = currentTime; // Gán thời gian hiện tại cho bài hát

				$(this).val(percentage); // Đặt giá trị cho progress bar

				// Tương tự, cập nhật giá trị của progress bar và tô màu tương ứng
				updateProgressBar(currentTime, duration);
			});

			function updateProgressBar(currentTime, duration) {
				var progress = (currentTime / duration) * 100;
				$("#progressbar").val(progress);

				// Tô màu cho progress bar tương ứng
				if (progress >= 0 && progress <= 25) {
					$("#progressbar").removeClass().addClass("progress_controls low-progress");
				} else if (progress > 25 && progress <= 75) {
					$("#progressbar").removeClass().addClass("progress_controls mid-progress");
				} else {
					$("#progressbar").removeClass().addClass("progress_controls high-progress");
				}
			}

			// Function để phát hoặc dừng nhạc
			function togglePlayPause() {
				if (isPlaying) {
					currentSong.pause(); // Dừng nhạc nếu đang phát
				} else {
					currentSong.play(); // Phát nhạc nếu đang dừng
				}
				isPlaying = !isPlaying; // Đảo ngược trạng thái phát
				// Cập nhật biểu tượng phát/dừng
				$("#play-pause-button").toggleClass("fa-pause-circle fa-play-circle");
			}

			// Bắt sự kiện thời gian của nhạc thay đổi
			currentSong.addEventListener("timeupdate", function() {
				var progress = (currentSong.currentTime / currentSong.duration) * 100;
				var currentTime = currentSong.currentTime;
				var duration = currentSong.duration;
				$("#progress-bar").val(progress);
				// Tô màu cho progress bar tương ứng
				if (progress >= 0 && progress <= 25) {
					$("#progress-bar").removeClass().addClass("progress_controls low-progress");
				} else if (progress > 25 && progress <= 75) {
					$("#progress-bar").removeClass().addClass("progress_controls mid-progress");
				} else {
					$("#progress-bar").removeClass().addClass("progress_controls high-progress");
				}
				updateTime(currentTime, duration);

			});
			function updateTime(currentTime, duration) {
				// Format thời gian bắt đầu và kết thúc thành phút:giây
				var currentFormatted = formatTime(currentTime);
				var durationFormatted = formatTime(duration);

				// Hiển thị thời gian bắt đầu và kết thúc trong HTML
				$("#start-time").text(currentFormatted);
				$("#end-time").text(durationFormatted);
			}
			function formatTime(time) {
				var minutes = Math.floor(time / 60);
				var seconds = Math.floor(time % 60);
				var formattedTime = minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
				return formattedTime;
			}

			currentSong.addEventListener("ended", function() {
				if (isLooping) {
					currentSong.currentTime = 0; // Quay lại đầu bài hát
					currentSong.play(); // Phát lại bài hát
				} else {
					var nextQueueItem;
					var queueItems = getAllQueueItems();
					if (isRandoming){
						var randomIndex = Math.floor(Math.random() * queueItems.length);
						nextQueueItem = queueItems.eq(randomIndex);
					}else {
						currentPostition++;
						console.log(currentPostition)

						if (currentPostition === queueItems.length ) {
							currentPostition = 0; // Reset to the first item if it's the last item
							nextQueueItem = queueItems.eq(0);
						}else
						{
							nextQueueItem = queueItems.eq(currentPostition);
						}
					}
					nextQueueItem.find('.play-song').click();
				}
			});
			$("#volume").click(function() {
				// Toggle mute/unmute
				if (currentSong.volume === 0) {
					currentSong.volume = 1; // Bật âm thanh
					$("#volume i").removeClass("fa-volume-mute").addClass("fa-volume-up"); // Thay đổi biểu tượng
				} else {
					currentSong.volume = 0; // Tắt âm thanh
					$("#volume i").removeClass("fa-volume-up").addClass("fa-volume-mute"); // Thay đổi biểu tượng
				}
			});
		});
	</script>









	<!--End of footer section-->
</body>
<!--End of body section-->
</html>
<!--End of html code-->